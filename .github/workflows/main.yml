name: Auto Update Worker
on:
  push:
    branches:
      - master
  schedule:
    - cron: "0 1 * * *" # æ¯å¤©UTCæ—¶é—´1ç‚¹æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´9ç‚¹ï¼‰
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°ï¼ˆå¿½ç•¥ç‰ˆæœ¬æ£€æŸ¥ï¼‰'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      # 1. åŸºç¡€ç¯å¢ƒå‡†å¤‡
      - name: æ£€å‡ºå½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false  # é˜²æ­¢å‡­è¯æ®‹ç•™

      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          echo "REPO_OWNER=ChefKissInc" >> $GITHUB_ENV
          echo "REPO_NAME=NootedRed" >> $GITHUB_ENV
          echo "TARGET_BRANCH=master" >> $GITHUB_ENV

      # 2. è¿œç¨‹ä»“åº“äº¤äº’
      - name: è·å–è¿œç¨‹ä»“åº“æœ€æ–°ä¿¡æ¯
        run: |
          git remote add origin-remote https://github.com/${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}.git
          git fetch origin-remote --depth=1 ${{ env.TARGET_BRANCH }}
          echo "REMOTE_COMMIT=$(git rev-parse origin-remote/${{ env.TARGET_BRANCH }})" >> $GITHUB_ENV

      # 3. æœ¬åœ°çŠ¶æ€æ£€æŸ¥
      - name: æ£€æŸ¥æœ¬åœ°ç‰ˆæœ¬
        run: |
          echo "LOCAL_COMMIT=$(git rev-parse HEAD)" >> $GITHUB_ENV
          echo "LOCAL_VERSION=$(cat version.txt 2>/dev/null || echo '0.0.0')" >> $GITHUB_ENV

      # 4. æ›´æ–°å†³ç­–
      - name: åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°
        run: |
          FORCE_UPDATE=${{ github.event.inputs.force_update == 'true' }}
          if [ "$FORCE_UPDATE" = true ] || [ "$LOCAL_COMMIT" != "$REMOTE_COMMIT" ]; then
            echo "NEED_UPDATE=true" >> $GITHUB_ENV
          else
            echo "NEED_UPDATE=false" >> $GITHUB_ENV
          fi

      # 5. æ ¸å¿ƒæ›´æ–°æµç¨‹ï¼ˆæ¡ä»¶æ‰§è¡Œï¼‰
      - name: å…‹éš†æˆ–æ›´æ–°è¿œç¨‹ä»“åº“
        if: env.NEED_UPDATE == 'true'
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•é¿å…è·¯å¾„æ±¡æŸ“
          mkdir temp-repo && cd temp-repo
          git clone --depth=1 https://github.com/${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}.git .
          git checkout ${{ env.TARGET_BRANCH }}

      # 6. è·¯å¾„è§„èŒƒåŒ–å¤„ç†
      - name: è·¯å¾„è§„èŒƒåŒ–å¤„ç†
        if: env.NEED_UPDATE == 'true'
        run: |
          # å¤„ç†é‡å¤ç›®å½•ç»“æ„
          find . -type d -name "NootedRed" -execdir mv {}/* . \; -execdir rmdir {} \;
          # å¤„ç†åµŒå¥—å¤´æ–‡ä»¶
          find PrivateHeaders -type d -name "PrivateHeaders" -execdir mv {}/* . \; -execdir rmdir {} \;

      # 7. æ–‡ä»¶æ¸…ç†ç­–ç•¥
      - name: æ¸…ç†éå¿…è¦æ–‡ä»¶
        if: env.NEED_UPDATE == 'true'
        run: |
          # åˆ›å»º.gitignoreè§„åˆ™
          cat > .gitignore << EOF
          /*
          !*.cpp
          !*.hpp
          !*.md
          !version.txt
          !LICENSE
          !README.md
          EOF
          # æ‰§è¡Œæ¸…ç†
          git clean -fdx

      # 8. æäº¤å‰æ ¡éªŒ
      - name: æäº¤å‰æ ¡éªŒ
        if: env.NEED_UPDATE == 'true'
        run: |
          # æ£€æŸ¥æœªè·Ÿè¸ªæ–‡ä»¶
          git status --porcelain | grep -q '^??' && { echo "å­˜åœ¨æœªè·Ÿè¸ªæ–‡ä»¶"; exit 1; }
          # æ£€æŸ¥æœªæäº¤ä¿®æ”¹
          git diff --exit-code --quiet || { echo "å­˜åœ¨æœªæäº¤ä¿®æ”¹"; exit 1; }

      # 9. æ‰§è¡Œæäº¤
      - name: æäº¤æ›´æ–°
        if: env.NEED_UPDATE == 'true'
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "ğŸ”„ è‡ªåŠ¨æ›´æ–°è‡³ ${{ env.REMOTE_VERSION }}"
          commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          branch: master
          commit_options: '--no-verify'  # è·³è¿‡å¯èƒ½å­˜åœ¨çš„æœ¬åœ°é’©å­
          file_pattern: '*.cpp *.hpp *.md version.txt'  # æ˜ç¡®æäº¤èŒƒå›´

      # 10. å¥åº·æ£€æŸ¥
      - name: å·¥ä½œæµå¥åº·æ£€æŸ¥
        if: always()
        run: |
          echo "::group::ç³»ç»ŸçŠ¶æ€æŠ¥å‘Š"
          echo "å½“å‰åˆ†æ”¯: $(git rev-parse --abbrev-ref HEAD)"
          echo "æœ€æ–°æäº¤: $(git log -1 --format=%h)"
          echo "ä¿®æ”¹æ–‡ä»¶: $(git diff --name-only HEAD^ HEAD 2>/dev/null)"
          echo "::endgroup::"

      # 11. æ¢å¤ç‚¹åˆ›å»º
      - name: åˆ›å»ºæ¢å¤ç‚¹
        run: git tag --force recovery-point-${{ github.run_number }}

      # 12. å¼‚å¸¸å›æ»š
      - name: å¼‚å¸¸å›æ»š
        if: failure()
        run: |
          git reset --hard recovery-point-${{ github.run_number }}
          git clean -fdx
