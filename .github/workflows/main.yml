name: Auto Update Worker
on:
  push:
    branches:
      - master  # ä¿®æ”¹è§¦å‘åˆ†æ”¯ä¸º master
  schedule:
    - cron: "0 1 * * *" # æ¯å¤©å‡Œæ™¨1ç‚¹è¿è¡Œï¼ˆUTCæ—¶é—´ï¼‰
  workflow_dispatch:
    inputs:
      force_update:
        description: 'æ˜¯å¦å¼ºåˆ¶æ›´æ–°ï¼ˆå¿½ç•¥ç‰ˆæœ¬æ£€æŸ¥ï¼‰'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          echo "REPO_OWNER=ChefKissInc" >> $GITHUB_ENV
          echo "REPO_NAME=NootedRed" >> $GITHUB_ENV
          echo "TARGET_BRANCH=master" >> $GITHUB_ENV  # æ˜ç¡®æŒ‡å®š master åˆ†æ”¯

      - name: è·å–è¿œç¨‹ä»“åº“æœ€æ–°ä¿¡æ¯
        run: |
          git remote add origin-remote https://github.com/${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}.git
          git fetch origin-remote --depth=1 ${{ env.TARGET_BRANCH }}
          REMOTE_VERSION=$(git describe --tags --always origin-remote/${{ env.TARGET_BRANCH }} 2>/dev/null | sed 's/^v//')
          REMOTE_COMMIT=$(git rev-parse origin-remote/${{ env.TARGET_BRANCH }})
          echo "REMOTE_VERSION=$REMOTE_VERSION" >> $GITHUB_ENV
          echo "REMOTE_COMMIT=$REMOTE_COMMIT" >> $GITHUB_ENV

      - name: æ£€æŸ¥æœ¬åœ°ç‰ˆæœ¬
        run: |
          LOCAL_COMMIT=$(git rev-parse HEAD)
          LOCAL_VERSION=$(cat version.txt 2>/dev/null || echo "0.0.0")
          echo "LOCAL_VERSION=$LOCAL_VERSION" >> $GITHUB_ENV
          echo "LOCAL_COMMIT=$LOCAL_COMMIT" >> $GITHUB_ENV

      - name: åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°
        run: |
          FORCE_UPDATE=${{ github.event.inputs.force_update || 'false' }}
          if [ "$FORCE_UPDATE" = "true" ] || [ "$LOCAL_COMMIT" != "$REMOTE_COMMIT" ]; then
            echo "éœ€è¦æ›´æ–°ï¼ˆå¼ºåˆ¶æ›´æ–°æˆ–è¿œç¨‹æœ‰æ–°æäº¤ï¼‰"
            exit 0
          else
            echo "å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
            exit 1
          fi
        id: need_update

      - name: å…‹éš†æˆ–æ›´æ–°è¿œç¨‹ä»“åº“
        if: steps.need_update.outcome == 'success'
        run: |
          git clone --depth=1 https://github.com/${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}.git temp-repo
          cd temp-repo
          git checkout ${{ env.TARGET_BRANCH }}  # ç¡®ä¿æ£€å‡º master åˆ†æ”¯
          cp -r ./* ../
          cd ..
          rm -rf temp-repo
          CURRENT_VERSION=$(git describe --tags --always 2>/dev/null | sed 's/^v//')
          echo "$CURRENT_VERSION" > version.txt

      - name: æäº¤æ›´æ–°
        if: steps.need_update.outcome == 'success'
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "ğŸ”„ è‡ªåŠ¨æ›´æ–°ä»“åº“ä»£ç è‡³ ${REMOTE_VERSION}"
          commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          branch: master  # ç¡®ä¿æäº¤åˆ° master åˆ†æ”¯
